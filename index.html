<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Triple L Runners</title>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = { darkMode: 'class' }
    </script>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
        import React, { useState, useEffect, useMemo } from 'react';
import { Sun, Moon, Plus, X, ArrowRight, Edit, Trash2, Zap, Flame, Mountain, Trophy, Download, Upload, LogOut, Users, BarChart2, CheckCircle, Target } from 'lucide-react';

// Helper Functions
const convertDistance = (distance, currentUnits, targetUnits) => {
  if (currentUnits === targetUnits) return distance;
  const kmToMiles = 0.621371;
  return targetUnits === 'miles' ? distance * kmToMiles : distance / kmToMiles;
};

const formatTime = (totalSeconds) => {
  if (isNaN(totalSeconds) || totalSeconds < 0) return "00:00";
  const hours = Math.floor(totalSeconds / 3600);
  const minutes = Math.floor((totalSeconds % 3600) / 60);
  const seconds = Math.floor(totalSeconds % 60);
  
  const paddedMinutes = String(minutes).padStart(2, '0');
  const paddedSeconds = String(seconds).padStart(2, '0');
  
  if (hours > 0) {
    return `${hours}:${paddedMinutes}:${paddedSeconds}`;
  }
  return `${paddedMinutes}:${paddedSeconds}`;
};

const parseTimeToSeconds = (timeStr) => {
  if (!timeStr || typeof timeStr !== 'string') return 0;
  const parts = timeStr.split(':').map(Number);
  let totalSeconds = 0;
  if (parts.length === 3) { // HH:MM:SS
    totalSeconds = parts[0] * 3600 + parts[1] * 60 + parts[2];
  } else if (parts.length === 2) { // MM:SS
    totalSeconds = parts[0] * 60 + parts[1];
  }
  return totalSeconds;
};

const calculatePace = (distance, timeStr, units) => {
    const totalSeconds = parseTimeToSeconds(timeStr);
    if (distance <= 0 || totalSeconds <= 0) return '0:00';
    const paceInSecondsPerKm = totalSeconds / distance;
    if (units === 'km') {
        return formatTime(paceInSecondsPerKm);
    } else {
        const paceInSecondsPerMile = paceInSecondsPerKm / 0.621371;
        return formatTime(paceInSecondsPerMile);
    }
};


const generateTrainingPlan = () => ({
    "5k": {
        name: "5K Speed Crusher",
        duration: 8,
        icon: Zap,
        gradient: "from-yellow-400 to-orange-500",
        schedule: [
            // Week 1
            ["Rest or Cross-Train", "3km Easy", "4x400m intervals", "3km Easy", "5km Long Run", "Rest", "Yoga/Stretching"],
            // Week 2 - 7 more weeks
            ...Array(7).fill(["3km Easy", "Speed Work", "Tempo Run", "3km Easy", "Long Run", "Rest", "Yoga/Stretching"])
        ]
    },
    "10k": {
        name: "10K Endurance Beast",
        duration: 10,
        icon: Flame,
        gradient: "from-red-500 to-pink-500",
        schedule: [
            // Week 1
            ["Rest", "5km Easy", "6x400m intervals", "5km Easy", "8km Long Run", "Rest", "Sun salutations yoga"],
            // 9 more weeks
            ...Array(9).fill(["5km Easy", "Speed Work", "Tempo Run", "5km Easy", "Long Run", "Rest", "Yoga/Stretching"])
        ]
    },
    "half-marathon": {
        name: "Half Marathon Conqueror",
        duration: 12,
        icon: Mountain,
        gradient: "from-blue-500 to-purple-600",
        schedule: [
             // Week 1
            ["Rest", "5km Easy", "Tempo Run (5km)", "5km Easy", "10km Long Run", "Rest", "Full body stretch"],
            // 11 more weeks
            ...Array(11).fill(["Easy Run", "Hill Repeats", "Tempo Run", "Easy Run", "Long Run", "Rest", "Foam Rolling"])
        ]
    },
    "marathon": {
        name: "Marathon Destroyer",
        duration: 16,
        icon: Trophy,
        gradient: "from-purple-500 to-indigo-600",
        schedule: [
            // Week 1
            ["Cross-Train", "6km Easy", "8x400m intervals", "6km Easy", "12km Long Run", "Rest", "Yoga for runners"],
            // 15 more weeks
            ...Array(15).fill(["Easy Run", "Speed Work", "Tempo Run", "Medium Run", "Long Run", "Rest", "Active Recovery"])
        ]
    }
});


// Main App Component
export default function App() {
    // STATE MANAGEMENT
    const [user, setUser] = useState(null);
    const [runs, setRuns] = useState([]);
    const [friends, setFriends] = useState([]);
    const [units, setUnits] = useState('km');
    const [theme, setTheme] = useState('dark');
    const [activeTab, setActiveTab] = useState('dashboard');
    
    // MODAL STATES
    const [isAddRunModalOpen, setAddRunModalOpen] = useState(false);
    const [isAddFriendModalOpen, setAddFriendModalOpen] = useState(false);
    const [editingRun, setEditingRun] = useState(null);

    // TRAINING PLAN STATE
    const [selectedPlan, setSelectedPlan] = useState(null);
    const [selectedWeek, setSelectedWeek] = useState(1);

    // LOGIN FORM STATE
    const [loginForm, setLoginForm] = useState({ name: '', email: '' });
    
    // --- LOCALSTORAGE PERSISTENCE ---
    useEffect(() => {
        try {
            const storedUser = localStorage.getItem('lll_user');
            if (storedUser) setUser(JSON.parse(storedUser));

            const storedRuns = localStorage.getItem('lll_runs');
            if (storedRuns) setRuns(JSON.parse(storedRuns));

            const storedFriends = localStorage.getItem('lll_friends');
            if (storedFriends) setFriends(JSON.parse(storedFriends));

            const storedUnits = localStorage.getItem('lll_units');
            if (storedUnits) setUnits(storedUnits);

            const storedTheme = localStorage.getItem('lll_theme');
            if (storedTheme) {
                setTheme(storedTheme);
            } else {
                 // Set theme based on system preference if no theme is stored
                const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
                setTheme(prefersDark ? 'dark' : 'light');
            }
        } catch (error) {
            console.error("Failed to load data from localStorage:", error);
        }
    }, []);

    useEffect(() => {
        try {
            if (user) localStorage.setItem('lll_user', JSON.stringify(user));
            else localStorage.removeItem('lll_user');

            localStorage.setItem('lll_runs', JSON.stringify(runs));
            localStorage.setItem('lll_friends', JSON.stringify(friends));
            localStorage.setItem('lll_units', units);
            localStorage.setItem('lll_theme', theme);
            
            if (theme === 'dark') {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        } catch (error) {
            console.error("Failed to save data to localStorage:", error);
        }
    }, [user, runs, friends, units, theme]);

    // --- COMPUTED STATS ---
    const stats = useMemo(() => {
        const totalRuns = runs.length;
        const totalDistanceKm = runs.reduce((sum, run) => sum + run.distance, 0);
        
        const now = new Date();
        const oneWeekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
        const firstDayOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
        
        const thisWeekDistanceKm = runs
            .filter(run => new Date(run.date) >= oneWeekAgo)
            .reduce((sum, run) => sum + run.distance, 0);

        const thisMonthDistanceKm = runs
            .filter(run => new Date(run.date) >= firstDayOfMonth)
            .reduce((sum, run) => sum + run.distance, 0);
            
        let bestPace = "N/A";
        let longestRunKm = 0;

        if (runs.length > 0) {
            longestRunKm = Math.max(...runs.map(r => r.distance));
            
            const paces = runs.map(run => {
                const totalSeconds = parseTimeToSeconds(run.time);
                return totalSeconds > 0 ? totalSeconds / run.distance : Infinity;
            });
            const bestPaceSecondsPerKm = Math.min(...paces);
            if (bestPaceSecondsPerKm !== Infinity) {
                bestPace = calculatePace(1, formatTime(bestPaceSecondsPerKm), 'km');
            }
        }

        const totalDistance = units === 'miles' ? convertDistance(totalDistanceKm, 'km', 'miles') : totalDistanceKm;
        const thisWeekDistance = units === 'miles' ? convertDistance(thisWeekDistanceKm, 'km', 'miles') : thisWeekDistanceKm;
        const thisMonthDistance = units === 'miles' ? convertDistance(thisMonthDistanceKm, 'km', 'miles') : thisMonthDistanceKm;
        const longestRun = units === 'miles' ? convertDistance(longestRunKm, 'km', 'miles') : longestRunKm;

        if(units === 'miles' && bestPace !== 'N/A') {
             const paceSeconds = parseTimeToSeconds(bestPace);
             const milePaceSeconds = paceSeconds * 1.60934;
             bestPace = formatTime(milePaceSeconds)
        }

        return {
            totalRuns,
            totalDistance: totalDistance.toFixed(2),
            thisWeek: thisWeekDistance.toFixed(2),
            thisMonth: thisMonthDistance.toFixed(2),
            bestPace: bestPace,
            longestRun: longestRun.toFixed(2),
        };
    }, [runs, units]);

    // --- HANDLER FUNCTIONS ---
    const handleLogin = (e) => {
        e.preventDefault();
        if (loginForm.name && loginForm.email) {
            setUser({ name: loginForm.name, email: loginForm.email });
        }
    };
    
    const handleLogout = () => {
        localStorage.removeItem('lll_user');
        setUser(null);
        setLoginForm({ name: '', email: '' });
    };

    const toggleTheme = () => setTheme(theme === 'dark' ? 'light' : 'dark');
    const toggleUnits = () => setUnits(units === 'km' ? 'miles' : 'km');

    const handleAddOrUpdateRun = (runData) => {
        if (editingRun) {
            setRuns(runs.map(r => r.id === editingRun.id ? { ...r, ...runData } : r));
        } else {
            setRuns([{ ...runData, id: Date.now() }, ...runs]);
        }
        setAddRunModalOpen(false);
        setEditingRun(null);
    };

    const handleEditRun = (run) => {
        setEditingRun(run);
        setAddRunModalOpen(true);
    };

    const handleDeleteRun = (runId) => {
        if (window.confirm("Are you sure you want to delete this run?")) {
            setRuns(runs.filter(r => r.id !== runId));
        }
    };
    
    const handleAddFriend = (friendEmail) => {
        if (friendEmail && !friends.find(f => f.email === friendEmail)) {
            setFriends([...friends, { email: friendEmail, since: new Date().toISOString().split('T')[0] }]);
        }
        setAddFriendModalOpen(false);
    };
    
    const removeFriend = (email) => {
        setFriends(friends.filter(f => f.email !== email));
    };

    const handleExport = () => {
        const data = JSON.stringify({ user, runs, friends, units, theme }, null, 2);
        const blob = new Blob([data], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'triple_l_runners_data.json';
        a.click();
        URL.revokeObjectURL(url);
    };

    const handleImport = (event) => {
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const importedData = JSON.parse(e.target.result);
                    if(window.confirm("Importing will overwrite current data. Continue?")){
                        setUser(importedData.user || null);
                        setRuns(importedData.runs || []);
                        setFriends(importedData.friends || []);
                        setUnits(importedData.units || 'km');
                        setTheme(importedData.theme || 'dark');
                    }
                } catch (error) {
                    alert("Error parsing JSON file. Please check the file format.");
                    console.error("Import error:", error);
                }
            };
            reader.readAsText(file);
            event.target.value = null; // Reset file input
        }
    };
    
    // --- RENDER ---

    if (!user) {
        return <LoginScreen form={loginForm} setForm={setLoginForm} onLogin={handleLogin} />;
    }

    const trainingPlans = generateTrainingPlan();
    const currentPlanDetails = selectedPlan ? trainingPlans[selectedPlan] : null;

    return (
        <div className="min-h-screen bg-gray-100 dark:bg-gray-900 text-gray-800 dark:text-gray-200 font-sans transition-colors duration-300">
            <div className="flex flex-col lg:flex-row">
                {/* --- SIDEBAR --- */}
                <nav className="bg-white dark:bg-gray-800/50 backdrop-blur-lg border-b lg:border-r border-gray-200 dark:border-gray-700 lg:w-64 lg:min-h-screen p-4 lg:p-6 sticky top-0 lg:relative z-20">
                    <div className="flex items-center justify-between">
                         <h1 className="text-2xl font-bold bg-gradient-to-r from-purple-500 to-indigo-600 bg-clip-text text-transparent">Triple L Runners</h1>
                         <div className="lg:hidden">
                            <button onClick={handleLogout} className="p-2 rounded-md hover:bg-gray-200 dark:hover:bg-gray-700 transition-colors">
                                <LogOut size={20} />
                            </button>
                         </div>
                    </div>
                    <div className="mt-2 text-sm text-gray-500 dark:text-gray-400">Welcome, {user.name}</div>
                   
                    <ul className="mt-8 space-y-2">
                        <NavTab icon={BarChart2} label="Dashboard" activeTab={activeTab} name="dashboard" onClick={() => setActiveTab('dashboard')} />
                        <NavTab icon={CheckCircle} label="Runs" activeTab={activeTab} name="runs" onClick={() => setActiveTab('runs')} />
                        <NavTab icon={Target} label="Training Plans" activeTab={activeTab} name="training" onClick={() => setActiveTab('training')} />
                        <NavTab icon={Users} label="Friends" activeTab={activeTab} name="friends" onClick={() => setActiveTab('friends')} />
                    </ul>
                    
                    <div className="mt-10 pt-4 border-t border-gray-200 dark:border-gray-700 space-y-4">
                        <div className="flex justify-between items-center">
                            <span className="text-sm font-medium">Theme</span>
                            <ThemeToggle theme={theme} toggleTheme={toggleTheme} />
                        </div>
                         <div className="flex justify-between items-center">
                            <span className="text-sm font-medium">Units</span>
                            <UnitToggle units={units} toggleUnits={toggleUnits} />
                        </div>
                         <div className="flex space-x-2 mt-4">
                            <button onClick={handleExport} className="w-full flex items-center justify-center gap-2 text-sm py-2 px-3 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 rounded-lg transition-colors">
                                <Download size={16}/> Export
                            </button>
                            <label className="w-full flex items-center justify-center gap-2 text-sm py-2 px-3 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 rounded-lg transition-colors cursor-pointer">
                                <Upload size={16}/> Import
                                <input type="file" accept=".json" className="hidden" onChange={handleImport} />
                            </label>
                        </div>
                    </div>

                    <div className="mt-auto pt-6 hidden lg:block">
                        <button onClick={handleLogout} className="w-full flex items-center gap-2 text-sm py-2 px-3 text-gray-500 dark:text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700 rounded-lg transition-colors">
                            <LogOut size={16} /> Logout
                        </button>
                    </div>
                </nav>

                {/* --- MAIN CONTENT --- */}
                <main className="flex-1 p-4 sm:p-6 lg:p-8">
                    {activeTab === 'dashboard' && <DashboardContent stats={stats} units={units} recentRuns={runs.slice(0, 5)} onAddRun={() => setAddRunModalOpen(true)} />}
                    {activeTab === 'runs' && <RunsContent runs={runs} units={units} onAddRun={() => setAddRunModalOpen(true)} onEdit={handleEditRun} onDelete={handleDeleteRun} />}
                    {activeTab === 'training' && <TrainingContent plans={trainingPlans} selectedPlan={selectedPlan} setSelectedPlan={setSelectedPlan} selectedWeek={selectedWeek} setSelectedWeek={setSelectedWeek} units={units}/>}
                    {activeTab === 'friends' && <FriendsContent friends={friends} onAddFriend={() => setAddFriendModalOpen(true)} onRemoveFriend={removeFriend} currentUserStats={stats} units={units} />}
                </main>
            </div>
            
            {isAddRunModalOpen && <AddRunModal onClose={() => { setAddRunModalOpen(false); setEditingRun(null); }} onSubmit={handleAddOrUpdateRun} existingRun={editingRun} units={units} />}
            {isAddFriendModalOpen && <AddFriendModal onClose={() => setAddFriendModalOpen(false)} onAdd={handleAddFriend} />}
        </div>
    );
}

// --- SUB-COMPONENTS ---

const LoginScreen = ({ form, setForm, onLogin }) => (
    <div className="min-h-screen flex items-center justify-center p-4 bg-gray-900 overflow-hidden">
        <div className="absolute top-0 left-0 w-full h-full">
            <div className="absolute -top-1/4 -left-1/4 w-96 h-96 bg-purple-500 rounded-full filter blur-3xl opacity-30 animate-blob"></div>
            <div className="absolute -bottom-1/4 -right-1/4 w-96 h-96 bg-indigo-500 rounded-full filter blur-3xl opacity-30 animate-blob animation-delay-2000"></div>
             <div className="absolute -bottom-1/4 -left-1/4 w-80 h-80 bg-pink-500 rounded-full filter blur-3xl opacity-30 animate-blob animation-delay-4000"></div>
        </div>
        <div className="relative z-10 w-full max-w-md">
            <div className="bg-white/10 backdrop-blur-xl border border-white/20 rounded-2xl shadow-lg p-8 text-white">
                <h1 className="text-3xl font-bold text-center mb-2 bg-gradient-to-r from-purple-400 to-indigo-400 bg-clip-text text-transparent">
                    Triple L Runners
                </h1>
                <p className="text-center text-gray-300 mb-8">For Luca, Louis & Lewis</p>
                <form onSubmit={onLogin} className="space-y-6">
                    <div>
                        <label className="block text-sm font-medium text-gray-300 mb-2">Name</label>
                        <input
                            type="text"
                            required
                            value={form.name}
                            onChange={(e) => setForm({ ...form, name: e.target.value })}
                            className="w-full px-4 py-2 bg-white/10 border border-white/20 rounded-lg focus:ring-2 focus:ring-purple-400 focus:outline-none transition-all"
                            placeholder="Enter your name"
                        />
                    </div>
                    <div>
                        <label className="block text-sm font-medium text-gray-300 mb-2">Email</label>
                        <input
                            type="email"
                            required
                            value={form.email}
                            onChange={(e) => setForm({ ...form, email: e.target.value })}
                            className="w-full px-4 py-2 bg-white/10 border border-white/20 rounded-lg focus:ring-2 focus:ring-purple-400 focus:outline-none transition-all"
                            placeholder="your.email@example.com"
                        />
                    </div>
                    <button type="submit" className="w-full font-bold py-3 px-4 bg-gradient-to-r from-purple-500 to-indigo-600 rounded-lg hover:from-purple-600 hover:to-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-900 focus:ring-purple-500 transform hover:scale-105 transition-all duration-300">
                        Join Triple L Runners
                    </button>
                </form>
            </div>
        </div>
    </div>
);


const NavTab = ({ icon: Icon, label, activeTab, name, ...props }) => {
    const isActive = activeTab === name;
    return (
        <li>
            <button
                {...props}
                className={`w-full flex items-center gap-3 px-4 py-3 rounded-lg text-sm font-semibold transition-all duration-200 ${
                    isActive
                        ? 'bg-purple-100 dark:bg-purple-500/20 text-purple-600 dark:text-purple-300'
                        : 'text-gray-500 dark:text-gray-400 hover:bg-gray-100 dark:hover:bg-gray-700/50 hover:text-gray-800 dark:hover:text-gray-200'
                }`}
            >
                <Icon size={20} className={isActive ? 'text-purple-500 dark:text-purple-400' : ''}/>
                <span className={isActive ? 'bg-gradient-to-r from-purple-600 to-indigo-600 dark:from-purple-400 dark:to-indigo-400 bg-clip-text text-transparent' : ''}>
                    {label}
                </span>
            </button>
        </li>
    );
};

const ThemeToggle = ({ theme, toggleTheme }) => (
    <button onClick={toggleTheme} className="p-2 rounded-full bg-gray-200 dark:bg-gray-700 text-gray-600 dark:text-gray-300">
        {theme === 'dark' ? <Sun size={18} /> : <Moon size={18} />}
    </button>
);

const UnitToggle = ({ units, toggleUnits }) => (
    <div className="flex items-center p-1 rounded-full bg-gray-200 dark:bg-gray-700">
        <button onClick={units !== 'km' ? toggleUnits : undefined} className={`px-3 py-1 text-sm rounded-full ${units === 'km' ? 'bg-white dark:bg-gray-900 shadow' : ''}`}>km</button>
        <button onClick={units !== 'miles' ? toggleUnits : undefined} className={`px-3 py-1 text-sm rounded-full ${units === 'miles' ? 'bg-white dark:bg-gray-900 shadow' : ''}`}>miles</button>
    </div>
);

const DashboardContent = ({ stats, units, recentRuns, onAddRun }) => (
    <div>
        <div className="flex justify-between items-center mb-6">
            <h2 className="text-3xl font-bold">Dashboard</h2>
            <button onClick={onAddRun} className="flex items-center gap-2 py-2 px-4 bg-purple-600 text-white rounded-lg font-semibold hover:bg-purple-700 transition-transform transform hover:scale-105">
                <Plus size={20} /> Add Run
            </button>
        </div>
        
        {/* Stat Cards */}
        <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-6 gap-4 mb-8">
            <StatCard title="Total Runs" value={stats.totalRuns} gradient="from-blue-400 to-blue-600"/>
            <StatCard title="Total Distance" value={`${stats.totalDistance} ${units}`} gradient="from-green-400 to-green-600"/>
            <StatCard title="This Week" value={`${stats.thisWeek} ${units}`} gradient="from-yellow-400 to-yellow-600"/>
            <StatCard title="This Month" value={`${stats.thisMonth} ${units}`} gradient="from-orange-400 to-orange-600"/>
            <StatCard title="Best Pace" value={stats.bestPace !== "N/A" ? `${stats.bestPace} /${units}` : 'N/A'} gradient="from-red-400 to-red-600"/>
            <StatCard title="Longest Run" value={`${stats.longestRun} ${units}`} gradient="from-purple-400 to-purple-600"/>
        </div>

        {/* Recent Runs */}
        <div>
            <h3 className="text-2xl font-bold mb-4">Recent Runs</h3>
            {recentRuns.length > 0 ? (
                <div className="space-y-4">
                    {recentRuns.map(run => <RunCard key={run.id} run={run} units={units} isCompact={true} />)}
                </div>
            ) : (
                <div className="text-center py-10 bg-white dark:bg-gray-800/50 rounded-2xl">
                    <p className="text-gray-500 dark:text-gray-400">No runs logged yet.</p>
                    <button onClick={onAddRun} className="mt-4 flex mx-auto items-center gap-2 py-2 px-4 bg-purple-600 text-white rounded-lg font-semibold hover:bg-purple-700 transition-transform transform hover:scale-105">
                        <Plus size={20} /> Log Your First Run
                    </button>
                </div>
            )}
        </div>
    </div>
);

const StatCard = ({ title, value, gradient }) => (
    <div className={`p-4 rounded-2xl text-white shadow-lg bg-gradient-to-br ${gradient} transition-transform transform hover:-translate-y-1`}>
        <p className="text-sm font-medium opacity-80">{title}</p>
        <p className="text-2xl font-bold mt-1">{value}</p>
    </div>
);

const RunsContent = ({ runs, units, onAddRun, onEdit, onDelete }) => (
     <div>
        <div className="flex justify-between items-center mb-6">
            <h2 className="text-3xl font-bold">My Runs</h2>
            <button onClick={onAddRun} className="flex items-center gap-2 py-2 px-4 bg-purple-600 text-white rounded-lg font-semibold hover:bg-purple-700 transition-transform transform hover:scale-105">
                <Plus size={20} /> Add Run
            </button>
        </div>
        {runs.length > 0 ? (
             <div className="space-y-4">
                {runs.map(run => (
                    <RunCard key={run.id} run={run} units={units} onEdit={onEdit} onDelete={onDelete} />
                ))}
            </div>
        ) : (
             <div className="text-center py-16 bg-white dark:bg-gray-800/50 rounded-2xl">
                <p className="text-gray-500 dark:text-gray-400 text-lg">Your running history will appear here.</p>
                <button onClick={onAddRun} className="mt-4 flex mx-auto items-center gap-2 py-2 px-4 bg-purple-600 text-white rounded-lg font-semibold hover:bg-purple-700 transition-transform transform hover:scale-105">
                    <Plus size={20} /> Log Your First Run
                </button>
            </div>
        )}
    </div>
);


const RunCard = ({ run, units, onEdit, onDelete, isCompact = false }) => {
    const displayDistance = units === 'miles' ? convertDistance(run.distance, 'km', 'miles') : run.distance;
    const pace = calculatePace(run.distance, run.time, 'km');
    const displayPace = units === 'miles' 
        ? formatTime(parseTimeToSeconds(pace) * 1.60934)
        : pace;

    const weatherEmojis = { Clear: '☀️', Cloudy: '☁️', Rainy: '🌧️', Hot: '🥵', Cold: '🥶', Windy: '💨' };
    const effortColors = [
        '#4ade80', '#86efac', '#bbf7d0', '#fde047', '#facc15', 
        '#fbbf24', '#fb923c', '#f97316', '#ef4444', '#dc2626'
    ];

    return (
        <div className="bg-white dark:bg-gray-800/50 p-4 rounded-2xl shadow-sm hover:shadow-lg transition-shadow duration-300 border border-transparent dark:border-gray-700/50">
            <div className="flex flex-wrap items-start justify-between">
                <div className="flex-1 min-w-[200px]">
                    <p className="text-sm text-gray-500 dark:text-gray-400">{new Date(run.date).toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</p>
                    <p className="text-2xl font-bold mt-1">{displayDistance.toFixed(2)} <span className="text-lg font-normal text-gray-600 dark:text-gray-300">{units}</span></p>
                </div>
                
                <div className="flex items-center gap-4 sm:gap-6 mt-2 sm:mt-0 text-center">
                    <div>
                        <p className="text-sm text-gray-500 dark:text-gray-400">Time</p>
                        <p className="font-semibold text-lg">{run.time}</p>
                    </div>
                    <div>
                        <p className="text-sm text-gray-500 dark:text-gray-400">Pace</p>
                        <p className="font-semibold text-lg">{displayPace} <span className="text-xs">/{units}</span></p>
                    </div>
                    {!isCompact && (
                        <div>
                            <p className="text-sm text-gray-500 dark:text-gray-400">Elevation</p>
                            <p className="font-semibold text-lg">{run.elevation || 0} m</p>
                        </div>
                    )}
                </div>
                 {!isCompact && onEdit && onDelete && (
                    <div className="flex items-center gap-2 mt-2 sm:mt-0 ml-auto pl-4">
                        <button onClick={() => onEdit(run)} className="p-2 text-gray-500 hover:text-blue-500 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full transition-colors"><Edit size={18} /></button>
                        <button onClick={() => onDelete(run.id)} className="p-2 text-gray-500 hover:text-red-500 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full transition-colors"><Trash2 size={18} /></button>
                    </div>
                )}
            </div>
            
            {!isCompact && (run.notes || run.weather || run.effort) && (
                <div className="mt-4 pt-4 border-t border-gray-200 dark:border-gray-700">
                    {run.notes && <p className="text-sm text-gray-600 dark:text-gray-300 italic">"{run.notes}"</p>}
                    <div className="flex items-center flex-wrap gap-x-4 gap-y-2 mt-2 text-sm">
                        {run.effort && (
                             <div className="flex items-center gap-2">
                                <span className="font-semibold">Effort:</span>
                                <div className="flex items-center gap-1.5">
                                    <div className="w-4 h-4 rounded-full" style={{backgroundColor: effortColors[run.effort - 1]}}></div>
                                    <span>{run.effort}/10</span>
                                </div>
                             </div>
                        )}
                        {run.weather && (
                            <div className="flex items-center gap-2">
                                <span className="font-semibold">Weather:</span>
                                <span>{weatherEmojis[run.weather]} {run.weather}</span>
                            </div>
                        )}
                    </div>
                </div>
            )}
        </div>
    );
};

const TrainingContent = ({ plans, selectedPlan, setSelectedPlan, selectedWeek, setSelectedWeek, units }) => {
    const currentPlanDetails = selectedPlan ? plans[selectedPlan] : null;

    return (
        <div>
            <h2 className="text-3xl font-bold mb-6">Training Plans</h2>
            
            {!selectedPlan ? (
                <div className="grid md:grid-cols-2 gap-6">
                    {Object.entries(plans).map(([key, plan]) => (
                        <div key={key} onClick={() => setSelectedPlan(key)} className={`relative p-8 rounded-2xl text-white overflow-hidden cursor-pointer group bg-gradient-to-br ${plan.gradient}`}>
                            <div className="relative z-10">
                                <plan.icon className="w-12 h-12 mb-4 opacity-80" />
                                <h3 className="text-2xl font-bold mb-1">{plan.name}</h3>
                                <p className="opacity-90">{plan.duration} Weeks</p>
                            </div>
                            <ArrowRight className="absolute z-10 bottom-6 right-6 w-8 h-8 text-white opacity-0 group-hover:opacity-100 transform group-hover:translate-x-0 -translate-x-2 transition-all duration-300" />
                            <div className="absolute inset-0 bg-black/10 group-hover:bg-black/20 transition-colors duration-300"></div>
                        </div>
                    ))}
                </div>
            ) : (
                <div className="bg-white dark:bg-gray-800/50 p-6 rounded-2xl shadow-sm border border-gray-200 dark:border-gray-700">
                    <div className="flex flex-wrap gap-4 justify-between items-center mb-6">
                        <div className="flex items-center gap-4">
                            <button onClick={() => setSelectedPlan(null)} className="text-gray-500 dark:text-gray-400 hover:text-purple-600 dark:hover:text-purple-400 transition-colors">&larr; Back to plans</button>
                            <h3 className={`text-2xl font-bold bg-gradient-to-r ${currentPlanDetails.gradient} bg-clip-text text-transparent`}>{currentPlanDetails.name}</h3>
                        </div>
                        <div className="flex items-center gap-2">
                            <label htmlFor="week-select" className="font-medium">Week:</label>
                            <select
                                id="week-select"
                                value={selectedWeek}
                                onChange={(e) => setSelectedWeek(Number(e.target.value))}
                                className="bg-gray-100 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg p-2 focus:ring-purple-500 focus:border-purple-500"
                            >
                                {Array.from({ length: currentPlanDetails.duration }, (_, i) => i + 1).map(weekNum => (
                                    <option key={weekNum} value={weekNum}>{weekNum}</option>
                                ))}
                            </select>
                        </div>
                    </div>

                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-7 gap-3">
                        {['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'].map((day, index) => {
                            let workout = currentPlanDetails.schedule[selectedWeek - 1][index];
                            const isRestDay = workout.toLowerCase().includes('rest') || workout.toLowerCase().includes('yoga');
                            let distance = workout.match(/(\d+)km/);
                            if(distance){
                                const km = parseFloat(distance[1]);
                                const displayDist = units === 'miles' ? convertDistance(km, 'km', 'miles').toFixed(1) : km;
                                workout = workout.replace(`${distance[1]}km`, `${displayDist} ${units}`);
                            }

                            return (
                                <div key={day} className={`p-4 rounded-xl ${isRestDay ? 'bg-blue-50 dark:bg-blue-900/40 border-blue-200 dark:border-blue-800' : 'bg-green-50 dark:bg-green-900/40 border-green-200 dark:border-green-800'} border`}>
                                    <p className="font-bold text-sm text-gray-600 dark:text-gray-300">{day}</p>
                                    <p className="mt-2 text-sm">{workout}</p>
                                </div>
                            );
                        })}
                    </div>
                    
                    <div className="mt-8 p-4 bg-gray-100 dark:bg-gray-900/50 rounded-lg">
                        <h4 className="font-bold text-lg mb-2">Training Fundamentals</h4>
                        <p className="text-sm text-gray-600 dark:text-gray-400">
                           Remember to warm up before each run and cool down afterwards. Proper hydration and nutrition are key. Listen to your body and don't be afraid to take an extra rest day if you feel tired or sore. Consistency is more important than intensity.
                        </p>
                    </div>
                </div>
            )}
        </div>
    );
};


const FriendsContent = ({ friends, onAddFriend, onRemoveFriend, currentUserStats, units }) => (
    <div>
        <div className="flex justify-between items-center mb-6">
            <h2 className="text-3xl font-bold">Friends</h2>
            <button onClick={onAddFriend} className="flex items-center gap-2 py-2 px-4 bg-purple-600 text-white rounded-lg font-semibold hover:bg-purple-700 transition-transform transform hover:scale-105">
                <Plus size={20} /> Add Friend
            </button>
        </div>

        {/* Weekly Leaderboard */}
        <div className="mb-8">
            <h3 className="text-2xl font-bold mb-4">Weekly Leaderboard</h3>
            <div className="bg-white dark:bg-gray-800/50 p-4 rounded-2xl shadow-sm border border-gray-200 dark:border-gray-700/50">
                 <p className="text-center text-gray-500 dark:text-gray-400">Showing your stats for this week.</p>
                <div className="flex justify-around items-center text-center mt-4">
                    <div>
                        <p className="text-sm text-gray-500 dark:text-gray-400">Distance</p>
                        <p className="font-bold text-xl text-purple-600 dark:text-purple-400">{currentUserStats.thisWeek} {units}</p>
                    </div>
                    <div>
                        <p className="text-sm text-gray-500 dark:text-gray-400">Runs</p>
                        <p className="font-bold text-xl text-purple-600 dark:text-purple-400">{friends.length > 0 ? 'N/A' : currentUserStats.totalRuns}</p> {/* Placeholder */}
                    </div>
                </div>
            </div>
        </div>

        {/* Friend List */}
        <div>
            <h3 className="text-2xl font-bold mb-4">Friend List</h3>
            {friends.length > 0 ? (
                <div className="grid sm:grid-cols-2 lg:grid-cols-3 gap-4">
                    {friends.map(friend => (
                        <div key={friend.email} className="bg-white dark:bg-gray-800/50 p-4 rounded-2xl shadow-sm flex items-center justify-between border border-transparent dark:border-gray-700/50">
                            <div className="flex items-center gap-3">
                                <div className="w-10 h-10 rounded-full bg-gradient-to-br from-indigo-500 to-purple-500 flex items-center justify-center text-white font-bold">
                                    {friend.email.charAt(0).toUpperCase()}
                                </div>
                                <div>
                                    <p className="font-semibold truncate max-w-[120px]">{friend.email}</p>
                                    <p className="text-xs text-gray-500 dark:text-gray-400">Friends since {friend.since}</p>
                                </div>
                            </div>
                            <button onClick={() => onRemoveFriend(friend.email)} className="p-2 text-gray-400 hover:text-red-500 rounded-full hover:bg-gray-100 dark:hover:bg-gray-700">
                                <X size={18} />
                            </button>
                        </div>
                    ))}
                </div>
            ) : (
                <div className="text-center py-16 bg-white dark:bg-gray-800/50 rounded-2xl">
                    <p className="text-gray-500 dark:text-gray-400 text-lg">You haven't added any friends yet.</p>
                    <button onClick={onAddFriend} className="mt-4 flex mx-auto items-center gap-2 py-2 px-4 bg-purple-600 text-white rounded-lg font-semibold hover:bg-purple-700 transition-transform transform hover:scale-105">
                        <Plus size={20} /> Add your first friend
                    </button>
                </div>
            )}
        </div>
    </div>
);

// --- MODALS ---

const Modal = ({ children, onClose, title }) => (
    <div className="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 z-50" onClick={onClose}>
        <div className="bg-white dark:bg-gray-800 rounded-2xl shadow-xl w-full max-w-md p-6" onClick={(e) => e.stopPropagation()}>
            <div className="flex justify-between items-center mb-4">
                <h3 className="text-xl font-bold">{title}</h3>
                <button onClick={onClose} className="p-1 rounded-full text-gray-400 hover:bg-gray-200 dark:hover:bg-gray-700">
                    <X size={22} />
                </button>
            </div>
            {children}
        </div>
    </div>
);

const AddRunModal = ({ onClose, onSubmit, existingRun, units }) => {
    const isEditing = !!existingRun;
    const [formData, setFormData] = useState({
        distance: existingRun ? existingRun.distance : '',
        time: existingRun ? existingRun.time : '',
        elevation: existingRun ? existingRun.elevation || '' : '',
        date: existingRun ? existingRun.date : new Date().toISOString().split('T')[0],
        effort: existingRun ? existingRun.effort : 5,
        weather: existingRun ? existingRun.weather : 'Clear',
        notes: existingRun ? existingRun.notes || '' : '',
    });

    const handleChange = (e) => {
        const { name, value } = e.target;
        setFormData(prev => ({ ...prev, [name]: value }));
    };

    const handleSubmit = (e) => {
        e.preventDefault();
        const { distance, time, elevation, date, effort, weather, notes } = formData;
        // Basic validation
        if (!distance || !time || !date) {
            alert("Please fill in Distance, Time, and Date.");
            return;
        }
        onSubmit({
            distance: parseFloat(distance),
            time,
            elevation: elevation ? parseInt(elevation, 10) : null,
            date,
            effort: parseInt(effort, 10),
            weather,
            notes
        });
    };
    
    const effortLevels = { 1: "Very Easy", 2: "Easy", 3: "Gentle", 4: "Moderate", 5: "Comfortable", 6: "Steady", 7: "Hard", 8: "Very Hard", 9: "Grueling", 10: "Maximum" };
    const weatherOptions = { Clear: '☀️', Cloudy: '☁️', Rainy: '🌧️', Hot: '🥵', Cold: '🥶', Windy: '💨' };
    
    return (
        <Modal onClose={onClose} title={isEditing ? 'Edit Run' : 'Add a New Run'}>
            <form onSubmit={handleSubmit} className="space-y-4">
                <div className="grid grid-cols-2 gap-4">
                    <div>
                        <label className="block text-sm font-medium mb-1">Distance ({units})</label>
                        <input type="number" name="distance" value={formData.distance} onChange={handleChange} required step="0.01" className="w-full form-input" placeholder="e.g., 5.2"/>
                    </div>
                    <div>
                        <label className="block text-sm font-medium mb-1">Time</label>
                        <input type="text" name="time" value={formData.time} onChange={handleChange} required className="w-full form-input" placeholder="MM:SS or HH:MM:SS"/>
                    </div>
                </div>
                 <div className="grid grid-cols-2 gap-4">
                    <div>
                        <label className="block text-sm font-medium mb-1">Elevation (m)</label>
                        <input type="number" name="elevation" value={formData.elevation} onChange={handleChange} className="w-full form-input" placeholder="Optional"/>
                    </div>
                     <div>
                        <label className="block text-sm font-medium mb-1">Date</label>
                        <input type="date" name="date" value={formData.date} onChange={handleChange} required className="w-full form-input"/>
                    </div>
                </div>
                <div className="grid grid-cols-2 gap-4">
                    <div>
                         <label className="block text-sm font-medium mb-1">Effort Level</label>
                         <select name="effort" value={formData.effort} onChange={handleChange} className="w-full form-input">
                            {Object.entries(effortLevels).map(([level, desc]) => (
                                <option key={level} value={level}>{level} - {desc}</option>
                            ))}
                         </select>
                    </div>
                     <div>
                        <label className="block text-sm font-medium mb-1">Weather</label>
                        <select name="weather" value={formData.weather} onChange={handleChange} className="w-full form-input">
                           {Object.entries(weatherOptions).map(([weather, emoji]) => (
                                <option key={weather} value={weather}>{emoji} {weather}</option>
                            ))}
                        </select>
                    </div>
                </div>
                <div>
                     <label className="block text-sm font-medium mb-1">Notes</label>
                     <textarea name="notes" value={formData.notes} onChange={handleChange} rows="3" className="w-full form-input" placeholder="How did it feel? Any PBs?"></textarea>
                </div>
                <button type="submit" className="w-full py-2 px-4 bg-purple-600 text-white font-semibold rounded-lg hover:bg-purple-700 transition-colors">
                    {isEditing ? 'Save Changes' : 'Add Run'}
                </button>
            </form>
        </Modal>
    );
};

const AddFriendModal = ({ onClose, onAdd }) => {
    const [email, setEmail] = useState('');

    const handleSubmit = (e) => {
        e.preventDefault();
        if(email) {
            onAdd(email);
        }
    };
    
    return (
        <Modal onClose={onClose} title="Add a Friend">
            <form onSubmit={handleSubmit} className="space-y-4">
                 <div>
                    <label className="block text-sm font-medium mb-1">Friend's Email</label>
                    <input type="email" value={email} onChange={(e) => setEmail(e.target.value)} required className="w-full form-input" placeholder="friend@example.com"/>
                </div>
                <button type="submit" className="w-full py-2 px-4 bg-purple-600 text-white font-semibold rounded-lg hover:bg-purple-700 transition-colors">
                    Add Friend
                </button>
            </form>
        </Modal>
    );
};

// Add some global styles for form inputs etc.
const style = document.createElement('style');
style.textContent = `
    .form-input {
        @apply block w-full px-3 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg text-sm placeholder-gray-400 dark:placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent transition-colors;
    }
    .animate-blob {
        animation: blob 7s infinite;
    }
    .animation-delay-2000 {
        animation-delay: 2s;
    }
    .animation-delay-4000 {
        animation-delay: 4s;
    }
    @keyframes blob {
        0% { transform: translate(0px, 0px) scale(1); }
        33% { transform: translate(30px, -50px) scale(1.1); }
        66% { transform: translate(-20px, 20px) scale(0.9); }
        100% { transform: translate(0px, 0px) scale(1); }
    }
`;
document.head.append(style);
    </script>
</body>
</html>
